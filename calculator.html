<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cost Estimator | Logikos.in</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/mrdoob/three.js@r128/examples/js/loaders/STLLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/mrdoob/three.js@r128/examples/js/controls/OrbitControls.js"></script>
    <style>
        .controls-row { display: flex; gap: 20px; flex-wrap: wrap; margin-top: 15px; }
        .controls-row > div { flex: 1; min-width: 200px; }
        /* Ensure the viewer has a height before the script runs */
        #viewer { 
            width: 100%; 
            height: 400px; 
            background: #f9f9f9; 
            border: 1px solid #ddd; 
            margin-top: 20px; 
            border-radius: 8px;
            display: none; /* Hidden until file is uploaded */
        }
        .result-table { width: 100%; margin-top: 20px; border-collapse: collapse; }
        .result-table td { padding: 10px; border-bottom: 1px solid #eee; }
        .total-row { font-weight: bold; font-size: 1.2em; color: #28a745; background: #f0fff0; }
    </style>
</head>
<body>
    <nav>
        <div class="logo">LOGIKOS.IN</div>
        <ul>
            <li><a href="index.html">Home</a></li>
            <li><a href="services.html">Services</a></li>
            <li><a href="shop.html">Shop</a></li>
            <li><a href="calculator.html">Cost Estimator</a></li>
        </ul>
    </nav>

    <div class="container">
        <h2>3D Printing Cost Estimator</h2>
        <div class="card">
            <div class="controls-row">
                <div>
                    <label>1. Material Type</label>
                    <select id="material" class="file-input">
                        <option value="1.24">PLA (1.24 g/cm³)</option>
                        <option value="1.04">ABS (1.04 g/cm³)</option>
                        <option value="1.27">PETG (1.27 g/cm³)</option>
                    </select>
                </div>
                <div>
                    <label>2. Infill Density (%)</label>
                    <input type="range" id="infill" min="0" max="100" value="20" oninput="document.getElementById('infillVal').innerText = this.value">
                    <span id="infillVal">20</span>%
                </div>
            </div>

            <label style="margin-top: 20px; display: block;">3. Upload STL File</label>
            <input type="file" id="stl_file" accept=".stl" class="file-input" />

            <div id="loader" style="display:none; margin-top:15px; color:#007bff;">Analyzing geometry...</div>
            
            <div id="viewer"></div>

            <div id="result-card" style="display:none;">
                <table class="result-table">
                    <tr><td>Net Model Volume</td><td style="text-align:right;"><span id="volume">0</span> mm³</td></tr>
                    <tr><td>Calculated Weight</td><td style="text-align:right;"><span id="weight">0</span> g</td></tr>
                    <tr class="total-row"><td>Estimated Total</td><td style="text-align:right;">₹<span id="price">0</span></td></tr>
                </table>
                <p style="font-size: 0.85em; color: #666; margin-top: 10px;">*Based on standard ₹7/gram rate. Final price subject to orientation and support requirements.</p>
            </div>
        </div>
    </div>

    <script>
        const pricePerGram = 7;
        const viewerEl = document.getElementById('viewer');
        let scene, camera, renderer, controls, currentMesh;

        function setupViewer() {
            if (scene) return;
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(45, viewerEl.clientWidth / viewerEl.clientHeight, 0.1, 1000);
            camera.position.set(150, 150, 150);

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(viewerEl.clientWidth, viewerEl.clientHeight);
            renderer.setClearColor(0x000000, 0); // Transparent background
            viewerEl.appendChild(renderer.domElement);

            scene.add(new THREE.HemisphereLight(0xffffff, 0x444444, 1.2));
            const light = new THREE.DirectionalLight(0xffffff, 0.8);
            light.position.set(1, 1, 1);
            scene.add(light);

            // Accessing OrbitControls from the non-module script tag
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            animate();
        }

        function animate() {
            requestAnimationFrame(animate);
            if (controls) controls.update();
            if (renderer) renderer.render(scene, camera);
        }

        document.getElementById('stl_file').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            document.getElementById('loader').style.display = 'block';
            const reader = new FileReader();
            reader.onload = function() {
                const loader = new THREE.STLLoader();
                const geometry = loader.parse(this.result);
                
                // Show viewer and setup if first time
                viewerEl.style.display = 'block';
                setupViewer();

                // Clear previous mesh
                if (currentMesh) scene.remove(currentMesh);

                // Center and Scale Geometry
                geometry.computeBoundingSphere();
                const center = geometry.boundingSphere.center;
                geometry.translate(-center.x, -center.y, -center.z);

                const material = new THREE.MeshStandardMaterial({ color: 0x007bff, metalness: 0.3, roughness: 0.5 });
                currentMesh = new THREE.Mesh(geometry, material);
                scene.add(currentMesh);

                // Position camera based on model size
                const radius = geometry.boundingSphere.radius;
                camera.position.set(radius * 2, radius * 2, radius * 2);
                camera.lookAt(0, 0, 0);

                // Math
                const vol = calculateVolume(geometry);
                const density = parseFloat(document.getElementById('material').value);
                const infill = parseFloat(document.getElementById('infill').value) / 100;
                
                // Simple logic: assume shell + infill averages to this weight
                const effectiveWeight = (vol / 1000) * density * (0.2 + (0.8 * infill)); 
                
                document.getElementById('volume').innerText = Math.round(vol);
                document.getElementById('weight').innerText = effectiveWeight.toFixed(2);
                document.getElementById('price').innerText = (effectiveWeight * pricePerGram).toFixed(2);
                
                document.getElementById('loader').style.display = 'none';
                document.getElementById('result-card').style.display = 'block';
            };
            reader.readAsArrayBuffer(file);
        });

        function calculateVolume(geometry) {
            let volume = 0;
            const pos = geometry.attributes.position.array;
            for (let i = 0; i < pos.length; i += 9) {
                let v1 = {x:pos[i], y:pos[i+1], z:pos[i+2]};
                let v2 = {x:pos[i+3], y:pos[i+4], z:pos[i+5]};
                let v3 = {x:pos[i+6], y:pos[i+7], z:pos[i+8]};
                volume += (-v3.x*v2.y*v1.z + v2.x*v3.y*v1.z + v3.x*v1.y*v2.z - v1.x*v3.y*v2.z - v2.x*v1.y*v3.z + v1.x*v2.y*v3.z) / 6;
            }
            return Math.abs(volume);
        }

        window.addEventListener('resize', () => {
            if (!renderer) return;
            camera.aspect = viewerEl.clientWidth / viewerEl.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(viewerEl.clientWidth, viewerEl.clientHeight);
        });
    </script>
</body>
</html>
