<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cost Estimator | Logikos.in</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/mrdoob/three.js@r128/examples/js/loaders/STLLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/mrdoob/three.js@r128/examples/js/controls/OrbitControls.js"></script>
</head>
<body>
    <nav>
        <div class="logo">LOGIKOS.IN</div>
        <ul>
            <li><a href="index.html">Home</a></li>
            <li><a href="services.html">Services</a></li>
            <li><a href="shop.html">Shop</a></li>
            <li><a href="calculator.html">Cost Estimator</a></li>
        </ul>
    </nav>

    <div class="container">
        <h2>3D Printing Cost Estimator</h2>
        <div class="card">
            <div class="controls-row">
                <div>
                    <label>1. Select Material</label>
                    <select id="material" class="file-input">
                        <option value="1.24">PLA (1.24 g/cm³)</option>
                        <option value="1.04">ABS (1.04 g/cm³)</option>
                        <option value="1.27">PETG (1.27 g/cm³)</option>
                    </select>
                </div>
                <div>
                    <label>2. Infill Density (%)</label>
                    <input type="range" id="infill" min="0" max="100" value="20" oninput="document.getElementById('infillVal').innerText = this.value">
                    <span id="infillVal">20</span>%
                </div>
            </div>

            <label style="margin-top: 20px; display: block;">3. Upload STL File</label>
            <input type="file" id="stl_file" accept=".stl" class="file-input" />
            
            <button id="calculateBtn" class="btn" style="width:100%; margin-top:15px; display:none; background:#28a745;">Calculate Quote</button>

            <div id="loader" style="display:none; margin-top:15px; color:#007bff;">Analyzing geometry...</div>
            
            <div id="viewer"></div>

            <div id="result-card" style="display:none;">
                <table class="result-table">
                    <tr><td>Raw Volume</td><td style="text-align:right;"><span id="volume">0</span> mm³</td></tr>
                    <tr><td>Estimated Weight</td><td style="text-align:right;"><span id="weight">0</span> g</td></tr>
                    <tr class="total-row"><td>Estimated Total</td><td style="text-align:right;">₹<span id="price">0</span></td></tr>
                </table>
                <p style="font-size: 0.85em; color: #666; margin-top: 15px;">*Price calculated at ₹7/gram. Final cost depends on print orientation and supports.</p>
            </div>
        </div>
    </div>

    <script>
        const pricePerGram = 7;
        const viewerEl = document.getElementById('viewer');
        let scene, camera, renderer, controls, currentMesh, stlVolume = 0;

        function setupViewer() {
            if (scene) return;
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xf9f9f9);
            
            camera = new THREE.PerspectiveCamera(45, viewerEl.clientWidth / viewerEl.clientHeight, 0.1, 5000);
            camera.position.set(250, 250, 250);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(viewerEl.clientWidth, viewerEl.clientHeight);
            viewerEl.appendChild(renderer.domElement);

            // Lighting
            scene.add(new THREE.HemisphereLight(0xffffff, 0x444444, 1.2));
            const light = new THREE.DirectionalLight(0xffffff, 0.5);
            light.position.set(1, 1, 1);
            scene.add(light);

            // Printer Base (Grid Helper)
            const grid = new THREE.GridHelper(220, 22, 0x000000, 0xcccccc);
            scene.add(grid);

            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            animate();
        }

        function animate() {
            requestAnimationFrame(animate);
            if (controls) controls.update();
            if (renderer) renderer.render(scene, camera);
        }

        document.getElementById('stl_file').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            document.getElementById('loader').style.display = 'block';
            document.getElementById('result-card').style.display = 'none';

            const reader = new FileReader();
            reader.onload = function() {
                const loader = new THREE.STLLoader();
                const geometry = loader.parse(this.result);
                
                viewerEl.style.display = 'block';
                document.getElementById('calculateBtn').style.display = 'block';
                setupViewer();

                if (currentMesh) scene.remove(currentMesh);

                // Center and position model on the grid
                geometry.computeBoundingBox();
                const center = new THREE.Vector3();
                geometry.boundingBox.getCenter(center);
                geometry.translate(-center.x, -geometry.boundingBox.min.y, -center.z);

                const material = new THREE.MeshStandardMaterial({ color: 0x007bff, metalness: 0.2, roughness: 0.5 });
                currentMesh = new THREE.Mesh(geometry, material);
                scene.add(currentMesh);

                // Auto-zoom to model
                const size = new THREE.Vector3();
                geometry.boundingBox.getSize(size);
                const maxDim = Math.max(size.x, size.y, size.z);
                camera.position.set(maxDim * 2, maxDim * 2, maxDim * 2);
                controls.update();

                stlVolume = calculateVolume(geometry);
                document.getElementById('loader').style.display = 'none';
            };
            reader.readAsArrayBuffer(file);
        });

        document.getElementById('calculateBtn').addEventListener('click', function() {
            if (stlVolume === 0) return;
            
            const density = parseFloat(document.getElementById('material').value);
            const infill = parseFloat(document.getElementById('infill').value) / 100;
            
            // Math: Weight = Volume * Density * (Infill adjustment)
            // Adjusting volume based on 20% shell and 80% variable infill
            const effectiveVolume = (stlVolume * 0.2) + (stlVolume * 0.8 * infill);
            const weightGrams = (effectiveVolume / 1000) * density; 
            const totalPrice = weightGrams * pricePerGram;
            
            document.getElementById('volume').innerText = Math.round(stlVolume);
            document.getElementById('weight').innerText = weightGrams.toFixed(2);
            document.getElementById('price').innerText = totalPrice.toFixed(2);
            document.getElementById('result-card').style.display = 'block';
        });

        function calculateVolume(geometry) {
            let volume = 0;
            const pos = geometry.attributes.position.array;
            for (let i = 0; i < pos.length; i += 9) {
                let v1 = {x:pos[i], y:pos[i+1], z:pos[i+2]};
                let v2 = {x:pos[i+3], y:pos[i+4], z:pos[i+5]};
                let v3 = {x:pos[i+6], y:pos[i+7], z:pos[i+8]};
                volume += (-v3.x*v2.y*v1.z + v2.x*v3.y*v1.z + v3.x*v1.y*v2.z - v1.x*v3.y*v2.z - v2.x*v1.y*v3.z + v1.x*v2.y*v3.z) / 6;
            }
            return Math.abs(volume);
        }
    </script>
</body>
</html>
