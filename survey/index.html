class SurveyEngine {
    constructor(data) {
        this.data = data;
        this.currentPageId = "p1";
        this.responses = {};
        this.history = [];
        this.selectedBranch = null;
    }

    init() { this.renderPage(); }

    renderPage() {
        const container = document.getElementById('surveyContainer');
        if (!container) return;
        container.innerHTML = '';
        
        const page = this.data.pages.find(p => p.id === this.currentPageId);

        const h1 = document.createElement('h1');
        h1.innerText = page.pageName;
        container.appendChild(h1);

        page.questions.forEach(q => {
            const wrapper = document.createElement('div');
            wrapper.className = 'question-block';
            if (this.currentPageId === 'p1') wrapper.style.textAlign = 'center';

            if (q.type === 'InfoBox') {
                const p = document.createElement('p');
                p.className = 'welcome-desc';
                p.innerText = q.content;
                wrapper.appendChild(p);
            } else {
                const label = document.createElement('label');
                label.className = 'q-text';
                label.innerText = q.label;
                wrapper.appendChild(label);
                
                if (q.type === 'DESQ') this.addDESQ(q, wrapper);
                else if (q.type.startsWith('MCQ')) this.addMCQ(q, wrapper, q.type==='MCQ_Multi');
                else if (q.type === 'List1') this.addList1(q, wrapper);
            }
            container.appendChild(wrapper);
        });
        this.addNav(page, container);
    }

    addDESQ(q, w) {
        const i = document.createElement('input');
        i.type = q.inputType || 'text';
        i.className = 'logikos-input';
        i.placeholder = "Enter Email";
        i.value = this.responses[q.id] || '';
        i.oninput = (e) => this.responses[q.id] = e.target.value;
        w.appendChild(i);
    }

    addMCQ(q, w, isMulti) {
        q.options.forEach(opt => {
            const r = document.createElement('label');
            r.className = 'option-row';
            const checked = isMulti ? (this.responses[q.id] || []).includes(opt) : this.responses[q.id] === opt;
            r.innerHTML = `<input type="${isMulti?'checkbox':'radio'}" name="${q.id}" ${checked?'checked':''}> ${opt}`;
            r.querySelector('input').onchange = (e) => {
                if (!isMulti) {
                    this.responses[q.id] = opt;
                    if(q.type === 'MCQ_Logic') this.selectedBranch = q.logic_map[opt];
                } else {
                    if(!this.responses[q.id]) this.responses[q.id] = [];
                    if(e.target.checked) this.responses[q.id].push(opt);
                    else this.responses[q.id] = this.responses[q.id].filter(i => i !== opt);
                }
            };
            w.appendChild(r);
        });
    }

    addList1(q, w) {
        // ... (Bubble logic remains same)
    }

    addNav(page, container) {
        const nav = document.createElement('div');
        nav.className = 'nav-btns';
        
        if (this.history.length > 0) {
            const b = document.createElement('button'); b.className = 'btn-box'; b.innerText = "BACK";
            b.onclick = () => { this.currentPageId = this.history.pop(); this.renderPage(); };
            nav.appendChild(b);
        }

        const n = document.createElement('button');
        n.className = 'btn-box';
        n.innerText = (page.id.startsWith('BRANCH') || page.isEnd) ? "SUBMIT" : "NEXT";
        n.onclick = () => {
            if (page.id === 'p1' && (!this.responses['email'] || !this.responses['email'].includes('@'))) {
                alert("Valid email required."); return;
            }
            if (page.id.startsWith('BRANCH') || page.isEnd) this.submitData();
            else {
                this.history.push(this.currentPageId);
                this.currentPageId = (this.currentPageId === 'p3' && this.selectedBranch) ? this.selectedBranch : page.nextPage;
                this.renderPage();
            }
        };
        nav.appendChild(n);
        container.appendChild(nav);
    }

    async submitData() {
        // Google Sheets post logic here...
        console.log("Submitting:", this.responses);
    }
}
